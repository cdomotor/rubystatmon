<!-- File: app/views/stations_imports/preview.html.erb -->
<!-- Path: /app/views/stations_imports/preview.html.erb -->

<h1 class="text-xl font-semibold mb-4">Preview Import</h1>

<% report = @report || { rows: [], totals: { creates: 0, updates: 0, skipped: 0, errors: 0 } } %>

<div class="rounded-lg border border-gray-200 bg-white p-3 overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-50 text-gray-600">
      <tr>
        <th class="px-3 py-2 text-left">Line</th>
        <th class="px-3 py-2 text-left">Action</th>
        <th class="px-3 py-2 text-left">Name</th>
        <th class="px-3 py-2 text-left">IP</th>
        <th class="px-3 py-2 text-left">Details</th>
        <th class="px-3 py-2 text-left">Errors</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      <% if report[:rows].blank? %>
        <tr>
          <td colspan="6" class="px-3 py-4 text-center text-gray-500">No rows parsed.</td>
        </tr>
      <% else %>
        <% report[:rows].each do |r| %>
          <tr>
            <td class="px-3 py-2"><%= r[:index] %></td>
            <td class="px-3 py-2">
              <% a = r[:action].to_s.upcase %>
              <span class="<%= { 'CREATE' => 'text-green-700', 'UPDATE' => 'text-blue-700', 'SKIP' => 'text-gray-500' }[a] %>"><%= a %></span>
            </td>
            <td class="px-3 py-2"><%= r.dig(:attrs, :name) %></td>
            <td class="px-3 py-2"><%= r.dig(:attrs, :ip_address) %></td>
            <td class="px-3 py-2 text-xs text-gray-600">
              <%= (r[:attrs] || {}).except(:id, :name, :ip_address).to_json %>
            </td>
            <td class="px-3 py-2 text-xs <%= r[:ok] ? 'text-gray-400' : 'text-red-600' %>">
              <% if r[:errors].present? %>
                <ul class="list-disc pl-4">
                  <% r[:errors].each do |e| %><li><%= e %></li><% end %>
                </ul>
              <% else %>
                —
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
</div>

<div class="mt-3 text-sm text-gray-700">
  <strong>Totals:</strong>
  Creates <%= report.dig(:totals, :creates) %> ·
  Updates <%= report.dig(:totals, :updates) %> ·
  Skipped <%= report.dig(:totals, :skipped) %> ·
  Errors <%= report.dig(:totals, :errors) %>
</div>

<%= form_with url: import_commit_stations_path, local: true do %>
  <%= hidden_field_tag :payload_b64, @payload_b64.to_s %>
  <%= hidden_field_tag :create_missing, @options&.fetch(:create_missing, true) %>
  <%= hidden_field_tag :update_existing, @options&.fetch(:update_existing, true) %>

  <div class="mt-4 flex gap-2">
    <%= link_to "Back", import_stations_path, class: "rounded-md bg-gray-100 px-4 py-2 text-sm hover:bg-gray-200" %>
    <%= submit_tag "Commit Import", class: "rounded-md bg-green-600 text-white px-4 py-2 text-sm hover:bg-green-700",
                   data: { turbo_confirm: "Are you sure? This will write to the database." } %>
  </div>
<% end %>
